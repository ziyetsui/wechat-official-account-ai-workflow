# 部署指南 - 微信云托管

## 部署方案选择

### 🎯 推荐：Express.js
- **原因**：我们的项目基于 Next.js，与 Express.js 完全兼容
- **优势**：部署简单，配置最少，性能优秀
- **适合**：AI 应用、API 服务、Web 应用

## 部署步骤

### 1. 准备项目文件

确保项目根目录包含以下文件：
- `Dockerfile` - Docker 构建文件
- `.dockerignore` - Docker 忽略文件
- `cloudbase.json` - 云托管配置文件
- `package.json` - 项目依赖配置

### 2. 配置环境变量

在微信云托管控制台配置以下环境变量：

```bash
# Azure OpenAI 配置
AZURE_OPENAI_BASE_URL=https://gpt-i18n.byteintl.net/gpt/openapi/online/v2/crawl/openai/deployments/gpt_openapi
AZURE_OPENAI_API_VERSION=2024-03-01-preview
AZURE_OPENAI_API_KEY=I2brwSdmty3dYeCtPIderK1lJzrIHYcc_GPT_AK
AZURE_OPENAI_MODEL_NAME=gemini-2.5-pro
AZURE_OPENAI_MAX_TOKENS=32000

# 微信公众号配置
WECHAT_APP_ID=wxc66e3754c009becc
WECHAT_APP_SECRET=您的开发者密码
```

### 3. 微信云托管部署

1. **登录微信云托管**
   - 访问：https://cloud.weixin.qq.com/
   - 使用微信扫码登录

2. **创建服务**
   - 点击"新建服务"
   - 选择"Express.js"模板
   - 填写服务名称：`wechat-ai-workflow`

3. **上传代码**
   - 选择"代码包上传"
   - 将整个项目文件夹打包为 ZIP 文件
   - 上传到云托管

4. **配置服务**
   - 端口：`3000`
   - 内存：`512MB`（推荐）
   - CPU：`0.5核`（推荐）
   - 实例数：`1-3个`（根据需求）

5. **环境变量配置**
   - 在服务配置中添加上述环境变量
   - 确保所有变量都正确设置

### 4. 部署和测试

1. **部署服务**
   - 点击"部署"按钮
   - 等待部署完成（通常 2-5 分钟）

2. **测试功能**
   - 访问部署后的域名
   - 测试文章生成功能
   - 测试排版功能
   - 测试发布功能

## 部署后配置

### 1. 微信公众号配置

部署完成后，需要更新微信公众号配置：

1. **IP白名单**
   - 登录微信公众平台
   - 进入"开发" -> "基本配置"
   - 添加微信云托管的 IP 地址

2. **服务器域名**
   - 在"服务器配置"中设置
   - 域名：`https://your-service.weixin.qq.com`

### 2. 域名配置（可选）

如果需要自定义域名：

1. **申请域名**
   - 购买域名或使用现有域名
   - 配置 DNS 解析

2. **SSL 证书**
   - 微信云托管自动提供 SSL 证书
   - 无需额外配置

## 监控和维护

### 1. 日志监控
- 在云托管控制台查看服务日志
- 监控错误和性能指标

### 2. 自动扩缩容
- 配置自动扩缩容规则
- 根据访问量自动调整实例数

### 3. 备份策略
- 定期备份代码和数据
- 配置自动备份

## 常见问题

### Q: 部署失败怎么办？
A: 检查 Dockerfile 和依赖配置，确保所有文件正确

### Q: 环境变量不生效？
A: 确保在云托管控制台正确配置环境变量

### Q: 微信公众号发布失败？
A: 检查 IP 白名单和开发者密码配置

### Q: 性能问题？
A: 调整内存和 CPU 配置，或增加实例数

## 成本估算

### 基础配置（推荐）
- 内存：512MB
- CPU：0.5核
- 实例数：1个
- 预估成本：约 30-50 元/月

### 高性能配置
- 内存：1GB
- CPU：1核
- 实例数：2个
- 预估成本：约 80-120 元/月

## 安全建议

1. **环境变量安全**
   - 不要在代码中硬编码敏感信息
   - 使用云托管的环境变量功能

2. **访问控制**
   - 配置适当的访问权限
   - 定期更新开发者密码

3. **监控告警**
   - 设置异常监控告警
   - 及时处理安全问题 